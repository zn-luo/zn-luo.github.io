(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{355:function(t,e,s){"use strict";s.r(e);var a=s(17),r=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"aws云主机重启后无法ssh登陆"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#aws云主机重启后无法ssh登陆"}},[t._v("#")]),t._v(" AWS云主机重启后无法ssh登陆")]),t._v(" "),e("p",[t._v("导致重启后无法ssh登陆的原因大体有两种:")]),t._v(" "),e("ol",[e("li",[t._v("系统能正常加载启动, ssh服务无法正常启动连接")]),t._v(" "),e("li",[t._v("系统无法正常加载启动")])]),t._v(" "),e("p",[t._v("当然具体原因还需要根据系统启动日志来定位问题。")]),t._v(" "),e("h2",{attrs:{id:"解决方法步骤"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解决方法步骤"}},[t._v("#")]),t._v(" 解决方法步骤")]),t._v(" "),e("h3",{attrs:{id:"分析原因"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#分析原因"}},[t._v("#")]),t._v(" 分析原因")]),t._v(" "),e("ol",[e("li",[t._v("登陆AWS云控制台"),e("a",{attrs:{href:"https://console.aws.amazon.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://console.aws.amazon.com"),e("OutboundLink")],1)]),t._v(" "),e("li",[t._v("进入EC2实例页面，右键单击有故障的云主机,选中监控和故障排队，点击获取系统日志，如下图所示"),e("br"),t._v(" "),e("img",{attrs:{src:"/imgs/aws/ec2-restart-failed/aws-ec2-system-log-menu.PNG",alt:"系统日志菜单",title:"系统日志菜单"}})]),t._v(" "),e("li",[t._v("进入获取系统日志页面，直接在控制台查看日志，或者点击右边的下载按钮(如下图所示)把日志文件下载下来。"),e("br"),t._v(" "),e("img",{attrs:{src:"/imgs/aws/ec2-restart-failed/system-log.PNG",alt:"ec2系统日志",title:"ec2系统日志"}})]),t._v(" "),e("li",[t._v("分析日志(我是直接把日志下载分析),如下图所示，从日志可以看到系统不断地在挂载一个名为nvme1n1i磁盘，尝试了很多次的挂载都没成功，启动的很多挂载job都time out失败了,最终Dependency failed for /data，挂载nvme1n1i到/data目录失败。"),e("br"),t._v(" "),e("img",{attrs:{src:"/imgs/aws/ec2-restart-failed/instance-system-log.PNG",alt:"ec2实例日志",title:"ec2实例日志"}})]),t._v(" "),e("li",[t._v("所以系统上的/etc/fstab文件应该被人不小心修改过了，我印象当中磁盘名应该为nvme1n1，所以需要修正fstab。"),e("br"),t._v("\n如果不知正确的磁盘名，可以将fstab挂载/data的磁盘注释掉，或者添加nofail参数，让系统挂载启动后，再用fdisk找出正确盘名改正。")])]),t._v(" "),e("h3",{attrs:{id:"修正-etc-fstab文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修正-etc-fstab文件"}},[t._v("#")]),t._v(" 修正/etc/fstab文件")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("备份当前实例,这样可以确保如果发生意外，可以从备份中取回之前的数据。"),e("br"),t._v("\n备份方式有: 1. 建立AMI [4]; 2. 是建立快照[5]")])]),t._v(" "),e("li",[e("p",[t._v("将实例停机")])]),t._v(" "),e("li",[e("p",[t._v("将实例的根卷(系统盘)分离(detach)[2],在同一个区域内(AZ)找一台可用实例或者新建一台小型号的实例，将刚刚分离的卷附加(attach)[3]可用实例。")])]),t._v(" "),e("li",[e("p",[t._v("登陆可用实例，将刚才附加的卷挂载(mount)为/data, 若无法正常挂载，查看"),e("a",{attrs:{href:"#%E6%8C%82%E8%BD%BD%E6%8A%A5%E9%94%99"}},[t._v("挂载报错")])])]),t._v(" "),e("li",[e("p",[t._v("编辑/data/etc/fstab,将错误的nvme1n1i(如下图error fstab所示)名改为nvme1n1名(如下图error fixed所示)"),e("br"),t._v(" "),e("img",{attrs:{src:"/imgs/aws/ec2-restart-failed/fstab-error.PNG",alt:"fstab-error",title:"error fstab"}}),t._v(" "),e("img",{attrs:{src:"/imgs/aws/ec2-restart-failed/fstab-error.PNG",alt:"fstab-fixed",title:"error fixed"}})])]),t._v(" "),e("li",[e("p",[t._v("或者将挂载/data那一行注释掉，或者修改为如下参数:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("LABEL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("cloudimg-rootfs\t/\t ext4\tdefaults,discard\t"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n/dev/nvme1n1    \t /data   ext4\tdefaults,nofail  "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("修正文件后，卸载(umount)刚才挂载的卷，将它挂回原来的实例当中(这里的默认根卷名为/dev/sda1)。")])]),t._v(" "),e("li",[e("p",[t._v("启动实例")])])]),t._v(" "),e("h2",{attrs:{id:"挂载报错"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#挂载报错"}},[t._v("#")]),t._v(" 挂载报错")]),t._v(" "),e("p",[t._v("挂载根卷时报错[6]:wrong fs type, bad option, bad superblock on /dev/xvdf, missing codepage or helper program, or other error, 如下图挂载报错所示"),e("br"),t._v(" "),e("img",{attrs:{src:"/imgs/aws/ec2-restart-failed/mount-error.PNG",alt:"挂载报错",title:"挂载报错"}})]),t._v(" "),e("p",[t._v("原因是此卷已经被分区了，执行fdisk -l命令可以看到分区的名字为/dev/xvdf1,如下图fdisk所示，所以不能直接挂载/dev/xvdf,面要挂载/dev/xvdf1,如下图mount-success所示。\n"),e("img",{attrs:{src:"/imgs/aws/ec2-restart-failed/mount-error.PNG",alt:"fdisk-l",title:"fdisk"}}),t._v(" "),e("img",{attrs:{src:"/imgs/aws/ec2-restart-failed/mount-error.PNG",alt:"mount-success",title:"mount-success"}})]),t._v(" "),e("h2",{attrs:{id:"文档引用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#文档引用"}},[t._v("#")]),t._v(" 文档引用")]),t._v(" "),e("p",[t._v("[1] "),e("a",{attrs:{href:"https://unix.stackexchange.com/questions/148714/cant-ssh-connection-terminates-immediately-with-exit-status-254",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://unix.stackexchange.com/questions/148714/cant-ssh-connection-terminates-immediately-with-exit-status-254"),e("OutboundLink")],1),e("br"),t._v("\n[2] "),e("a",{attrs:{href:"https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/ebs-detaching-volume.html#umount-detach-volume",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/ebs-detaching-volume.html#umount-detach-volume"),e("OutboundLink")],1),e("br"),t._v("\n[3] "),e("a",{attrs:{href:"https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/ebs-attaching-volume.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/ebs-attaching-volume.html"),e("OutboundLink")],1),e("br"),t._v("\n[4] "),e("a",{attrs:{href:"https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/creating-an-ami-ebs.html#how-to-create-ebs-ami",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/creating-an-ami-ebs.html#how-to-create-ebs-ami"),e("OutboundLink")],1),e("br"),t._v("\n[5] "),e("a",{attrs:{href:"https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html#ebs-create-snapshot",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html#ebs-create-snapshot"),e("OutboundLink")],1),e("br"),t._v("\n[6]"),e("a",{attrs:{href:"https://serverfault.com/questions/632905/cannot-mount-an-existing-ebs-on-aws",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://serverfault.com/questions/632905/cannot-mount-an-existing-ebs-on-aws"),e("OutboundLink")],1)]),t._v(" "),e("Vssue",{attrs:{title:t.$title,options:{locale:"zh"}}})],1)}),[],!1,null,null,null);e.default=r.exports}}]);